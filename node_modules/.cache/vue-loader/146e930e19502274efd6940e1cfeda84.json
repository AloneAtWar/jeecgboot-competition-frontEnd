{"remainingRequest":"D:\\a\\ant-design-vue-jeecg\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\a\\ant-design-vue-jeecg\\src\\components\\JVxeCells\\JVxeImageCell.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\a\\ant-design-vue-jeecg\\src\\components\\JVxeCells\\JVxeImageCell.vue","mtime":1661074531143},{"path":"D:\\a\\ant-design-vue-jeecg\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1657458637011},{"path":"D:\\a\\ant-design-vue-jeecg\\node_modules\\babel-loader\\lib\\index.js","mtime":1657458618345},{"path":"D:\\a\\ant-design-vue-jeecg\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1657458637011},{"path":"D:\\a\\ant-design-vue-jeecg\\node_modules\\vue-loader\\lib\\index.js","mtime":1657458571653}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { getFileAccessHttpUrl } from '@api/manage'\nimport JVxeCellMixins from '@/components/jeecg/JVxeTable/mixins/JVxeCellMixins'\nimport { ACCESS_TOKEN } from '@/store/mutation-types'\nimport JFilePop from '@/components/jeecg/minipop/JFilePop'\n\nimport JVxeUploadCell from '@/components/jeecg/JVxeTable/components/cells/JVxeUploadCell'\n\nexport default {\n  name: 'JVxeImageCell',\n  mixins: [JVxeCellMixins],\n  components: {JFilePop},\n  props: {},\n  data() {\n    return {\n      innerFile: null,\n      number:0\n    }\n  },\n  computed: {\n    /** upload headers */\n    uploadHeaders() {\n      let {originColumn: col} = this\n      let headers = {}\n      if (col.token === true) {\n        headers['X-Access-Token'] = this.$ls.get(ACCESS_TOKEN)\n      }\n      return headers\n    },\n\n    /** 上传请求地址 */\n    uploadAction() {\n      if (!this.originColumn.action) {\n        return window._CONFIG['domianURL'] + '/sys/common/upload'\n      } else {\n        return this.originColumn.action\n      }\n    },\n\n    hasFile() {\n      return this.innerFile != null\n    },\n\n    /** 预览图片地址 */\n    imgSrc() {\n      if (this.innerFile) {\n        if (this.innerFile['url']) {\n          return this.innerFile['url']\n        } else if (this.innerFile['path']) {\n          let path = this.innerFile['path'].split(',')[0]\n          return getFileAccessHttpUrl(path)\n        }\n      }\n      return ''\n    },\n\n    responseName() {\n      if (this.originColumn.responseName) {\n        return this.originColumn.responseName\n      } else {\n        return 'message'\n      }\n    },\n\n  },\n  watch: {\n    innerValue: {\n      immediate: true,\n      handler() {\n        if (this.innerValue) {\n          this.innerFile = this.innerValue\n        } else {\n          this.innerFile = null\n        }\n      },\n    },\n  },\n  methods: {\n\n    // 点击更多按钮\n    handleMoreOperation(originColumn) {\n      //update-begin-author:wangshuai date:20201021 for:LOWCOD-969 判断传过来的字段是否存在number，用于控制上传文件\n      if (originColumn.number) {\n        this.number = originColumn.number\n      } else {\n        this.number = 0\n      }\n      //update-end-author:wangshuai date:20201021 for:LOWCOD-969 判断传过来的字段是否存在number，用于控制上传文件\n      if(originColumn && originColumn.fieldExtendJson){\n        let json = JSON.parse(originColumn.fieldExtendJson);\n        this.number = json.uploadnum?json.uploadnum:0;\n      }\n      let path = ''\n      if (this.innerFile) {\n        path = this.innerFile.path\n      }\n      this.$refs.filePop.show('', path, 'img')\n    },\n\n    // 更多上传回调\n    handleFileSuccess(file) {\n      if (file) {\n        this.innerFile.path = file.path\n        this.handleChangeCommon(this.innerFile)\n      }\n    },\n\n    // 弹出上传出错详细信息\n    handleClickShowImageError() {\n      let file = this.innerFile || null\n      if (file && file['message']) {\n        this.$error({title: '上传出错', content: '错误信息：' + file['message'], maskClosable: true})\n      }\n    },\n\n    handleChangeUpload(info) {\n      let {originColumn: col} = this\n      let {file} = info\n      let value = {\n        name: file.name,\n        type: file.type,\n        size: file.size,\n        status: file.status,\n        percent: file.percent\n      }\n      if (file.response) {\n        value['responseName'] = file.response[this.responseName]\n      }\n      if (file.status === 'done') {\n        if (typeof file.response.success === 'boolean') {\n          if (file.response.success) {\n            value['path'] = file.response[this.responseName]\n            this.handleChangeCommon(value)\n          } else {\n            value['status'] = 'error'\n            value['message'] = file.response.message || '未知错误'\n          }\n        } else {\n          // 考虑到如果设置action上传路径为非jeecg-boot后台，可能不会返回 success 属性的情况，就默认为成功\n          value['path'] = file.response[this.responseName]\n          this.handleChangeCommon(value)\n        }\n      } else if (file.status === 'error') {\n        value['message'] = file.response.message || '未知错误'\n      }\n      this.innerFile = value\n    },\n\n    handleClickDownloadFile() {\n      if (this.imgSrc) {\n        window.open(this.imgSrc)\n      }\n    },\n\n    handleClickDeleteFile() {\n      this.handleChangeCommon(null)\n    },\n\n  },\n  // 【组件增强】注释详见：JVxeCellMixins.js\n  enhanced: {\n    switches: {visible: true},\n    getValue: value => JVxeUploadCell.enhanced.getValue(value),\n    setValue: value => JVxeUploadCell.enhanced.setValue(value),\n  }\n}\n",{"version":3,"sources":["JVxeImageCell.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA2DA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"JVxeImageCell.vue","sourceRoot":"src/components/JVxeCells","sourcesContent":["<template>\r\n  <div>\r\n    <template v-if=\"hasFile\" v-for=\"(file, fileKey) of [innerFile || {}]\">\r\n      <div :key=\"fileKey\" style=\"position: relative;\">\r\n        <template v-if=\"!file || !(file['url'] || file['path'] || file['message'])\">\r\n          <a-tooltip :title=\"'请稍后: ' + JSON.stringify (file) + ((file['url'] || file['path'] || file['message']))\">\r\n            <a-icon type=\"loading\"/>\r\n          </a-tooltip>\r\n        </template>\r\n        <template v-else-if=\"file['path']\">\r\n          <img class=\"j-editable-image\" :src=\"imgSrc\" alt=\"无图片\" @click=\"handleMoreOperation\"/>\r\n        </template>\r\n        <a-tooltip v-else :title=\"file.message||'上传失败'\" @click=\"handleClickShowImageError\">\r\n          <a-icon type=\"exclamation-circle\" style=\"color:red;\"/>\r\n        </a-tooltip>\r\n\r\n        <template style=\"width: 30px\">\r\n          <a-dropdown :trigger=\"['click']\" placement=\"bottomRight\" style=\"margin-left: 10px;\">\r\n            <a-tooltip title=\"操作\">\r\n              <a-icon\r\n                v-if=\"file.status!=='uploading'\"\r\n                type=\"setting\"\r\n                style=\"cursor: pointer;\"/>\r\n            </a-tooltip>\r\n\r\n            <a-menu slot=\"overlay\">\r\n              <a-menu-item v-if=\"originColumn.allowDownload !== false\" @click=\"handleClickDownloadFile\">\r\n                <span><a-icon type=\"download\"/>&nbsp;下载</span>\r\n              </a-menu-item>\r\n              <a-menu-item v-if=\"originColumn.allowRemove !== false\" @click=\"handleClickDeleteFile\">\r\n                <span><a-icon type=\"delete\"/>&nbsp;删除</span>\r\n              </a-menu-item>\r\n              <a-menu-item @click=\"handleMoreOperation(originColumn)\">\r\n                <span><a-icon type=\"bars\"/> 更多</span>\r\n              </a-menu-item>\r\n            </a-menu>\r\n          </a-dropdown>\r\n        </template>\r\n\r\n      </div>\r\n    </template>\r\n    <a-upload\r\n      v-show=\"!hasFile\"\r\n      name=\"file\"\r\n      :data=\"{'isup': 1}\"\r\n      :multiple=\"false\"\r\n      :action=\"uploadAction\"\r\n      :headers=\"uploadHeaders\"\r\n      :showUploadList=\"false\"\r\n      v-bind=\"cellProps\"\r\n      @change=\"handleChangeUpload\"\r\n    >\r\n      <a-button icon=\"upload\">{{originColumn.btnText || '上传图片'}}</a-button>\r\n    </a-upload>\r\n    <j-file-pop ref=\"filePop\" @ok=\"handleFileSuccess\" :number=\"number\"/>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\n  import { getFileAccessHttpUrl } from '@api/manage'\r\n  import JVxeCellMixins from '@/components/jeecg/JVxeTable/mixins/JVxeCellMixins'\r\n  import { ACCESS_TOKEN } from '@/store/mutation-types'\r\n  import JFilePop from '@/components/jeecg/minipop/JFilePop'\r\n\r\n  import JVxeUploadCell from '@/components/jeecg/JVxeTable/components/cells/JVxeUploadCell'\r\n\r\n  export default {\r\n    name: 'JVxeImageCell',\r\n    mixins: [JVxeCellMixins],\r\n    components: {JFilePop},\r\n    props: {},\r\n    data() {\r\n      return {\r\n        innerFile: null,\r\n        number:0\r\n      }\r\n    },\r\n    computed: {\r\n      /** upload headers */\r\n      uploadHeaders() {\r\n        let {originColumn: col} = this\r\n        let headers = {}\r\n        if (col.token === true) {\r\n          headers['X-Access-Token'] = this.$ls.get(ACCESS_TOKEN)\r\n        }\r\n        return headers\r\n      },\r\n\r\n      /** 上传请求地址 */\r\n      uploadAction() {\r\n        if (!this.originColumn.action) {\r\n          return window._CONFIG['domianURL'] + '/sys/common/upload'\r\n        } else {\r\n          return this.originColumn.action\r\n        }\r\n      },\r\n\r\n      hasFile() {\r\n        return this.innerFile != null\r\n      },\r\n\r\n      /** 预览图片地址 */\r\n      imgSrc() {\r\n        if (this.innerFile) {\r\n          if (this.innerFile['url']) {\r\n            return this.innerFile['url']\r\n          } else if (this.innerFile['path']) {\r\n            let path = this.innerFile['path'].split(',')[0]\r\n            return getFileAccessHttpUrl(path)\r\n          }\r\n        }\r\n        return ''\r\n      },\r\n\r\n      responseName() {\r\n        if (this.originColumn.responseName) {\r\n          return this.originColumn.responseName\r\n        } else {\r\n          return 'message'\r\n        }\r\n      },\r\n\r\n    },\r\n    watch: {\r\n      innerValue: {\r\n        immediate: true,\r\n        handler() {\r\n          if (this.innerValue) {\r\n            this.innerFile = this.innerValue\r\n          } else {\r\n            this.innerFile = null\r\n          }\r\n        },\r\n      },\r\n    },\r\n    methods: {\r\n\r\n      // 点击更多按钮\r\n      handleMoreOperation(originColumn) {\r\n        //update-begin-author:wangshuai date:20201021 for:LOWCOD-969 判断传过来的字段是否存在number，用于控制上传文件\r\n        if (originColumn.number) {\r\n          this.number = originColumn.number\r\n        } else {\r\n          this.number = 0\r\n        }\r\n        //update-end-author:wangshuai date:20201021 for:LOWCOD-969 判断传过来的字段是否存在number，用于控制上传文件\r\n        if(originColumn && originColumn.fieldExtendJson){\r\n          let json = JSON.parse(originColumn.fieldExtendJson);\r\n          this.number = json.uploadnum?json.uploadnum:0;\r\n        }\r\n        let path = ''\r\n        if (this.innerFile) {\r\n          path = this.innerFile.path\r\n        }\r\n        this.$refs.filePop.show('', path, 'img')\r\n      },\r\n\r\n      // 更多上传回调\r\n      handleFileSuccess(file) {\r\n        if (file) {\r\n          this.innerFile.path = file.path\r\n          this.handleChangeCommon(this.innerFile)\r\n        }\r\n      },\r\n\r\n      // 弹出上传出错详细信息\r\n      handleClickShowImageError() {\r\n        let file = this.innerFile || null\r\n        if (file && file['message']) {\r\n          this.$error({title: '上传出错', content: '错误信息：' + file['message'], maskClosable: true})\r\n        }\r\n      },\r\n\r\n      handleChangeUpload(info) {\r\n        let {originColumn: col} = this\r\n        let {file} = info\r\n        let value = {\r\n          name: file.name,\r\n          type: file.type,\r\n          size: file.size,\r\n          status: file.status,\r\n          percent: file.percent\r\n        }\r\n        if (file.response) {\r\n          value['responseName'] = file.response[this.responseName]\r\n        }\r\n        if (file.status === 'done') {\r\n          if (typeof file.response.success === 'boolean') {\r\n            if (file.response.success) {\r\n              value['path'] = file.response[this.responseName]\r\n              this.handleChangeCommon(value)\r\n            } else {\r\n              value['status'] = 'error'\r\n              value['message'] = file.response.message || '未知错误'\r\n            }\r\n          } else {\r\n            // 考虑到如果设置action上传路径为非jeecg-boot后台，可能不会返回 success 属性的情况，就默认为成功\r\n            value['path'] = file.response[this.responseName]\r\n            this.handleChangeCommon(value)\r\n          }\r\n        } else if (file.status === 'error') {\r\n          value['message'] = file.response.message || '未知错误'\r\n        }\r\n        this.innerFile = value\r\n      },\r\n\r\n      handleClickDownloadFile() {\r\n        if (this.imgSrc) {\r\n          window.open(this.imgSrc)\r\n        }\r\n      },\r\n\r\n      handleClickDeleteFile() {\r\n        this.handleChangeCommon(null)\r\n      },\r\n\r\n    },\r\n    // 【组件增强】注释详见：JVxeCellMixins.js\r\n    enhanced: {\r\n      switches: {visible: true},\r\n      getValue: value => JVxeUploadCell.enhanced.getValue(value),\r\n      setValue: value => JVxeUploadCell.enhanced.setValue(value),\r\n    }\r\n  }\r\n</script>\r\n\r\n<style scoped lang=\"less\">\r\n  .j-editable-image {\r\n    height: 32px;\r\n    max-width: 100px !important;\r\n    cursor: pointer;\r\n\r\n    &:hover {\r\n      opacity: 0.8;\r\n    }\r\n\r\n    &:active {\r\n      opacity: 0.6;\r\n    }\r\n\r\n  }\r\n</style>\r\n"]}]}